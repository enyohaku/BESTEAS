<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店鋪デモ１</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: rgb(246, 239, 202);
        }
        
        section {
            margin: 20px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 90%; /* モバイルデバイスでの表示を考慮 */
            max-width: 600px; /* 最大幅を設定 */
        }
        img {
            max-width: 100%; 
            height: auto;
        }
        canvas {
            display: block;
            max-width: 100%;
            margin: auto;
        }
        @media (min-width: 768px) {
            body {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            section {
                margin: 20px;
                width: calc(50% - 40px); /* 画面が広い場合は2列で表示 */
            }
            }
            fieldset {
            display: flex;
            flex-direction: column;
        }
    </style>
</head>
<body>
    <section id="store-info">
        <h1 id="store-name">店名: 旭園</h1>
        <P>住所： 静岡県島田市本町</P>
        <P id="store-product">試飲茶名 : 特選深蒸し茶 200g 1728円（税込）</P>
        <img src="img/fukamusi demo.jpg" alt="">
    </section>
    <section id="feedback">
        <fieldset>
            <canvas id="teaRatingChart" width="400" height="400"></canvas>
            <legend>お茶の評価</legend>
            <label for="astringency">渋み:</label>
            <input type="range" id="astringency" name="astringency" min="1" max="5" step="1">
            <label for="sweetness">甘み:</label>
            <input type="range" id="sweetness" name="sweetness" min="1" max="5" step="1">
            <label for="aroma">香り:</label>
            <input type="range" id="aroma" name="aroma" min="1" max="5" step="1">
            <label for="bitterness">苦味:</label>
            <input type="range" id="bitterness" name="bitterness" min="1" max="5" step="1">
            <label for="rarity">希少性:</label>
            <input type="range" id="rarity" name="rarity" min="1" max="5" step="1">
            <label for="favorite">お気に入り度:</label>
            <input type="range" id="favorite" name="favorite" min="1" max="10" step="1">
            <span id="favoriteValue">5</span>/10
        </fieldset>
        <div style="margin: 20px;">
            <button onclick="window.history.back();">前に戻る</button>
            <!-- 送信ボタンのonclickイベントを変更 -->
            <button type="button" id="submitFeedback">送信する</button>
            
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const ctx = document.getElementById('teaRatingChart').getContext('2d');
            const teaRatingChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['渋み', '甘み', '香り', '苦味', '希少性'],
                    datasets: [{
                        label: 'お茶の評価',
                        data: [1, 1, 1, 1, 1], // 初期値
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        r: {
                            beginAtZero: true,
                            min: 0,
                            max: 5,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        
            // スライダーの値が変更されたときにチャートを更新
            document.querySelectorAll('input[type=range]').forEach(input => {
                input.addEventListener('input', function () {
                    teaRatingChart.data.datasets[0].data = [
                        document.getElementById('astringency').value,
                        document.getElementById('sweetness').value,
                        document.getElementById('aroma').value,
                        document.getElementById('bitterness').value,
                        document.getElementById('rarity').value
                    ];
                    teaRatingChart.update();
                });
            });
        });
            document.addEventListener('DOMContentLoaded', function () {
                const favoriteSlider = document.getElementById('favorite');
                const favoriteValueDisplay = document.getElementById('favoriteValue');

        // スライダーの初期値を表示
        favoriteValueDisplay.textContent = favoriteSlider.value;

        // スライダーの値が変更されたときに実行
        favoriteSlider.addEventListener('input', function () {
            favoriteValueDisplay.textContent = this.value + '点';
            });
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
    
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getDatabase, ref, push, set, onChildAdded, remove,onChildRemoved }
        from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
        // Firebaseの設定をここに追加
            const firebaseConfig = {
            apiKey: "AIzaSyByDc2qEOQmj4-oswFJw1bPtGz-zZsYNBc",
            authDomain: "practice-5794d.firebaseapp.com",
            projectId: "practice-5794d",
            storageBucket: "practice-5794d.appspot.com",
            messagingSenderId: "694163464286",
            appId: "1:694163464286:web:40e5d3e9210dc63caf54cf"
        };

        // Firebaseを初期化
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        // const dbRef = ref(db, 'practice'); // RealtimeDatabase”practice“を使うよ


        // データをFirebaseに保存する関数
        function saveFeedback() {
            const astringency = document.getElementById('astringency').value;
            const sweetness = document.getElementById('sweetness').value;
            const aroma = document.getElementById('aroma').value;
            const bitterness = document.getElementById('bitterness').value;
            const rarity = document.getElementById('rarity').value;
            const favorite = document.getElementById('favorite').value;
            let storeName = document.getElementById('store-name').textContent; // 店名を取得
            storeName = storeName.replace('店名: ', ''); // "店名: "を削除

            localStorage.setItem('storeName', storeName);

            push(ref(db, 'practice/feedback'), {
            astringency: astringency,
            sweetness: sweetness,
            aroma: aroma,
            bitterness: bitterness,
            rarity: rarity,
            favorite: favorite,
            storeName: storeName
        })
        .then(() => {
        // ローカルストレージにフィードバックデータを保存
        localStorage.setItem('feedback', JSON.stringify({
            astringency: astringency,
            sweetness: sweetness,
            aroma: aroma,
            bitterness: bitterness,
            rarity: rarity,
            favorite: favorite,
            
        }));
        // ユーザーをthankyou.htmlにリダイレクト
        window.location.href = 'thankyou.html';
    })
    .catch((error) => {
        alert("エラーが発生しました: " + error);
    });
}  
    document.addEventListener('DOMContentLoaded', () => {
    const submitBtn = document.getElementById('submitFeedback');
    submitBtn.addEventListener('click', saveFeedback);
    });
    onChildAdded(ref(db, 'practice/feedback'), (snapshot) => {
    const feedback = snapshot.val();
    const feedbackContainer = document.createElement('div'); // フィードバックとチャートを含むコンテナ

    // テキスト情報を表示
    const feedbackText = document.createElement('p');
    feedbackText.textContent = `渋み: ${feedback.astringency}, 甘み: ${feedback.sweetness}, 香り: ${feedback.aroma}, 苦味: ${feedback.bitterness}, 希少性: ${feedback.rarity}, お気に入り度: ${feedback.favorite}`;
    feedbackContainer.appendChild(feedbackText);

    // チャートを表示するためのcanvas要素を作成
    const canvas = document.createElement('canvas');
    const canvasId = `chart-${snapshot.key}`; // snapshot.keyはFirebaseからの各フィードバックの一意のキー
    canvas.id = canvasId;
    feedbackContainer.appendChild(canvas);

    // コンテナをフィードバックリストに追加
    document.getElementById('feedback-list').appendChild(feedbackContainer);


    // チャートを描画
    const ctx = canvas.getContext('2d');
    new Chart(ctx, {
        type: 'radar',
        data: {
            labels: ['渋み', '甘み', '香り', '苦味', '希少性'],
            datasets: [{
                label: 'お茶の評価',
                data: [feedback.astringency, feedback.sweetness, feedback.aroma, feedback.bitterness, feedback.rarity],
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                r: {
                    beginAtZero: true,
                    min: 0,
                    max: 5,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // コンテナをフィードバックリストに追加
    document.getElementById('feedback-list').appendChild(feedbackContainer);
});
</script>
</body>
</html>